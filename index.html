<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fetch Image Data</title>
	<script src="https://unpkg.com/utif"></script>
	<link rel="stylesheet" href="style.css">
</head>

<body>
		<div id="img-container">
		</div>

	<script>
		let myvar;
		document.addEventListener('DOMContentLoaded', async () => {
			try {
				// Extract the ID from the URL Parameters
				const urlParams = new URLSearchParams(window.location.search);
				const id = urlParams.get('id');
				if (!id) throw new Error('ID parameter is missing in the URL');

				const elecciones = urlParams.get('elecciones');
				if (!id) throw new Error('ID parameter is missing in the URL');
				if (elecciones = 'paso') {
					const url = 'https://paso.resultados.gob.ar/backend-difu/scope/data/getTiff/';
				} else {
					const url = 'https://resultados.gob.ar/backend-difu/scope/data/getTiff/';
				}

				// Fetch the JSON Data
				const response = await fetch(`${url}${id}`);

				if (!response.ok) throw new Error('Network response was not ok');

				const jsonData = await response.json();

				// Convert the base64 string to a Uint8Array
				const tiffData = Uint8Array.from(atob(jsonData.encodingBinary), c => c.charCodeAt(0));

				// Parse the TIFF data
				const ifds = UTIF.decode(tiffData.buffer);

				for (let i=0; i<ifds.length; ++i) {
					UTIF.decodeImage(tiffData.buffer, ifds[i]);

					// Convert the TIFF to a PNG and display it
					const rgba = UTIF.toRGBA8(ifds[i]);  // Uint8Array with RGBA pixels
					const canvas = document.createElement('canvas');
					canvas.width = ifds[i].width;
					canvas.height = ifds[i].height;
					const ctx = canvas.getContext('2d');
					const imgData = new ImageData(new Uint8ClampedArray(rgba), ifds[i].width, ifds[i].height);
					ctx.putImageData(imgData, 0, 0);

					// Replace the img element's src with the canvas's data URL
					const imgElement = new Image();
					imgElement.onload = () => {
						imgElement.style.display = 'block';
						imgElement.classList.add('img');
					};
					imgElement.src = canvas.toDataURL('image/png');
					document.getElementById('img-container').appendChild(imgElement);
				}

			} catch (error) {
				console.error('There was an error!', error);
			}
		});
	</script>

</body>

</html>
